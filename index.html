<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MANTRA - AI Therapist</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #eef2f7; padding: 20px; }
    #chatbox { width: 100%; max-width: 500px; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; margin-bottom: 10px; }
    .user { color: blue; }
    .bot { color: green; }
    input, button { padding: 10px; font-size: 16px; margin: 2px; }
    #journalTable { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 600px; }
    #journalTable th, #journalTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #streakBox { background: #d3ffd3; padding: 10px; margin-top: 15px; border-radius: 5px; display: inline-block; }
  </style>
</head>
<body>
  <h2>MANTRA - Your AI Therapist</h2>
  <div id="chatbox"></div>
  <input id="userinput" placeholder="Type your thoughts..." style="width: 65%;">
  <button onclick="sendMessage()">Send</button>
  <button onclick="startVoiceInput()">ðŸŽ¤</button>
  <br>
  <button onclick="showGraph()">View Emotion Graph</button>
  <button onclick="showJournal()">Mood Journal</button>
  <button onclick="showAffirmation()">Daily Affirmation</button>
  <button onclick="showBreathing()">Breathing Exercise</button>
  <canvas id="moodChart" width="400" height="200" style="margin-top:10px;"></canvas>
  <div id="journal" style="display:none;"></div>
  <div id="streakBox" style="display:none;"></div>

  <script>
    let userEmail = prompt("Enter your email:");
    let recognition;
    let chatHistory = [];
    const affirmations = [
      "You are stronger than your struggles.",
      "Every day is a fresh start.",
      "You are doing the best you can, and that's enough.",
      "You are worthy of love and care.",
      "Healing takes time. Be gentle with yourself."
    ];

    async function sendMessage() {
      const input = document.getElementById("userinput").value;
      const chatbox = document.getElementById("chatbox");
      if (!input.trim()) return;

      chatbox.innerHTML += `<div class="user">You: ${input}</div>`;
      chatHistory.push({ role: "user", message: input });

      await fetch("http://127.0.0.1:8000/log_emotion", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: userEmail, text: input })
      });

      const res = await fetch("http://127.0.0.1:8000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: userEmail, text: input })
      });

      const data = await res.json();
      let responseText = data.response;

      if (input.toLowerCase().includes("suicide") || input.toLowerCase().includes("end it all")) {
        responseText += "<br><b>If you're in crisis, please contact a helpline immediately: <a href='https://988lifeline.org' target='_blank'>988 Suicide & Crisis Lifeline</a></b>";
      }

      chatbox.innerHTML += `<div class="bot">MANTRA: ${responseText} (Mood: ${data.mood})</div>`;
      chatHistory.push({ role: "bot", message: data.response });

      document.getElementById("userinput").value = "";
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Sorry, voice input not supported.");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.start();

      recognition.onresult = function(event) {
        document.getElementById("userinput").value = event.results[0][0].transcript;
        sendMessage();
      };
    }

    async function showGraph() {
      const data = await fetch("http://127.0.0.1:8000/emotion_history?email=" + userEmail);
      const history = await data.json();

      const labels = history.map(entry => entry.timestamp);
      const moodValues = history.map(entry =>
        entry.mood === "positive" ? 1 :
        entry.mood === "neutral" ? 0 : -1
      );

      const ctx = document.getElementById("moodChart").getContext("2d");
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Mood Over Time',
            data: moodValues,
            borderColor: 'blue',
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              min: -1,
              max: 1,
              ticks: {
                stepSize: 1,
                callback: val => val === 1 ? "Positive" : val === 0 ? "Neutral" : "Negative"
              }
            }
          }
        }
      });
    }

    function showBreathing() {
      alert("Try this: Inhale for 4 seconds, hold for 7, exhale for 8.
You can also check YouTube for '1-minute breathing exercise'.");
    }

    async function showJournal() {
      const res = await fetch("http://127.0.0.1:8000/emotion_history?email=" + userEmail);
      const data = await res.json();
      const journal = document.getElementById("journal");
      if (!data.length) {
        journal.innerHTML = "<p>No mood entries yet.</p>";
        return;
      }

      let table = `<table id="journalTable"><tr><th>Date & Time</th><th>Mood</th></tr>`;
      data.forEach(entry => {
        table += `<tr><td>${entry.timestamp}</td><td>${entry.mood}</td></tr>`;
      });
      table += `</table>`;
      journal.innerHTML = table;
      journal.style.display = "block";

      // Show streak
      let streak = 0;
      for (let i = data.length - 1; i >= 0; i--) {
        if (data[i].mood === "positive") streak++;
        else break;
      }
      const streakBox = document.getElementById("streakBox");
      streakBox.innerHTML = `You're on a <b>${streak}-day positive streak!</b> Keep it going!`;
      streakBox.style.display = "block";
    }

    function showAffirmation() {
      const a = affirmations[Math.floor(Math.random() * affirmations.length)];
      alert("Daily Affirmation:

" + a);
    }

    window.onbeforeunload = () => {
      localStorage.setItem(userEmail + "_chat", JSON.stringify(chatHistory));
    };

    window.onload = () => {
      const saved = localStorage.getItem(userEmail + "_chat");
      if (saved) {
        JSON.parse(saved).forEach(entry => {
          const div = `<div class="${entry.role}">${entry.role === "user" ? "You" : "MANTRA"}: ${entry.message}</div>`;
          document.getElementById("chatbox").innerHTML += div;
        });
      }
    };
  </script>
</body>
</html>
